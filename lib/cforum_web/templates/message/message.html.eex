<div class="posting-header">
  <%= header(@conn, @thread, @message, first: @first, do_parent: assigns[:do_parent], tree: false, show_editor: true, author_link_to_message: false, plate: true) %>
  <%= if assigns[:controls], do: render "votes_accept.html", Map.put(assigns, :top, true) %>
</div>

<%= unless blank?(@message.problematic_site) do %>
  <p class="problematic-site"><%= link gettext("problematic site"), to: @message.problematic_site, rel: "nofollow" %></p>
<% end %>

<div class="cf-posting-content<%= if @message.deleted, do: " deleted" %> e-content">
  <%= Cforum.MarkdownRenderer.to_html(@message, @conn.assigns) %>
</div>

<div class="posting-footer">
  <div class="button-container">
    <div class="message-links">
      <%= if present?(@message.cites) do %>
        <p class="message-cite"><%= {:safe, ngettext("This message got cited in cite %{cite_links}",
                                                    "This message got cited in cites %{cite_links}",
                                                    length(@message.cites), cite_links: cite_links(@conn, @message))} %></p>
      <% end %>

      <%= if assigns[:controls] && !@message.deleted, do: render("message_default_controls.html", assigns) %>
    </div>

    <%= if assigns[:controls], do: render "votes_accept.html", Map.put(assigns, :top, false) %>
  </div>

  <%= if assigns[:controls] && @view_all, do: render("message_admin_buttons.html", assigns) %>
  <%= if assigns[:controls] && !@message.deleted, do: render("message_forum_links.html", assigns) %>
</div>


<%= if present?(CloseVotes.get_close_vote(@message)) do %>
  <%= render "close_vote.html", Map.put(assigns, :close_vote, CloseVotes.get_close_vote(@message)) %>
<% end %>

<%= if present?(CloseVotes.get_reopen_vote(@message)) do %>
  <%= render "reopen_vote.html", Map.put(assigns, :reopen_vote, CloseVotes.get_reopen_vote(@message)) %>
<% end %>

<%= if @message.message_id == @thread.message.message_id and present?(@thread.accepted) do %>
  <h3><%= gettext("accepted answers") %></h3>

  <%= for msg <- @thread.accepted do %>
    <article class="cf-thread threadlist accepted">
      <%= header(@conn, @thread, msg, id: false, show_votes: true) %>
    </article>
  <% end %>
<% end %>

<%= if present?(Messages.references(@message, @conn.assigns.visible_forums, @thread, 1)) do %>
  <h3><%= gettext("The following messages reference this message:") %></h3>

  <%= for msg <- Messages.references(@message, @conn.assigns.visible_forums, @thread) do %>
    <article class="cf-thread threadlist reference">
      <%= header(@conn, @thread, msg, id: false, show_votes: true) %>
    </article>
  <% end %>
<% end %>
